<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="20241219-1-create-report-generation-table" author="system">
        <createTable tableName="report_generation">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_report_generation"/>
            </column>
            <column name="instance_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(20)">
                <constraints nullable="false"/>
            </column>
            <column name="language" type="varchar(5)">
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="end_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="requested_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="generation_start_date" type="timestamp"/>
            <column name="generation_end_date" type="timestamp"/>
            <column name="requested_by" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="error_message" type="text"/>
            <column name="retry_count" type="integer" defaultValueNumeric="0"/>
            <column name="last_retry_date" type="timestamp"/>
            <column name="parameters" type="jsonb"/>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="report_generation" 
            baseColumnNames="instance_id" 
            constraintName="fk_report_generation_instance" 
            referencedTableName="instance" 
            referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="20241219-2-create-report-generation-indexes" author="system">
        <createIndex indexName="idx_report_generation_status" tableName="report_generation">
            <column name="status"/>
        </createIndex>
        
        <createIndex indexName="idx_report_generation_requested_date" tableName="report_generation">
            <column name="requested_date"/>
        </createIndex>
        
        <sql>
            CREATE UNIQUE INDEX idx_report_generation_unique_instance 
            ON report_generation(instance_id) 
            WHERE status IN ('COMPLETED', 'IN_PROGRESS', 'PENDING');
        </sql>
    </changeSet>

    <changeSet id="20241219-3-create-report-file-table" author="system">
        <createTable tableName="report_file">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false" primaryKeyName="pk_report_file"/>
            </column>
            <column name="report_generation_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="blob_name" type="varchar(500)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_report_file_blob_name"/>
            </column>
            <column name="blob_container" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="file_name" type="varchar(500)">
                <constraints nullable="false"/>
            </column>
            <column name="content_type" type="varchar(100)">
                <constraints nullable="false"/>
            </column>
            <column name="file_size_bytes" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="checksum" type="varchar(64)">
                <constraints nullable="false"/>
            </column>
            <column name="upload_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="expiry_date" type="timestamp">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" defaultValueBoolean="false"/>
            <column name="package_contents" type="jsonb">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="report_file" 
            baseColumnNames="report_generation_id" 
            constraintName="fk_report_file_report_generation" 
            referencedTableName="report_generation" 
            referencedColumnNames="id"
            onDelete="CASCADE"/>
    </changeSet>

    <changeSet id="20241219-4-create-report-file-indexes" author="system">
        <createIndex indexName="idx_report_file_blob_name" tableName="report_file">
            <column name="blob_name"/>
        </createIndex>
        
        <createIndex indexName="idx_report_file_expiry_date" tableName="report_file">
            <column name="expiry_date"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>
